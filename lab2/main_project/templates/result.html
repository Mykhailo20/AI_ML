{% extends "base.html" %}
{% block header %}
<link rel="stylesheet" href="../static/css/styles.css">
<link rel="stylesheet" href="../static/css/result.css">
<title>Lab2: Результати обчислень</title>
{% endblock %}
{% block content %}
<h3 class="center-elem" id="h3-results">Результати обчислень</h3>
<div class="form-container">
    <table class="matrics-table">
        <tr class="matrics-table__row">
            <th colspan={{ cols_no }} class="matrics-table__th">Матриця попарних порівнянь</th>
        </tr>
    
        <tr class="matrics-table__row">
            {% for i in range(cols_no) %}
            <td class="matrics-table__td"></td>
            {% endfor %}
        </tr>
        
        <!-- Parameter values -->
        <tr class="matrics-table__row">
            <td class="matrics-table__td matrics-table__parameter">
                <input type="text" name="parameter_name_td_input" id="parameter_name_td_input" value="{{ fuzzy_set.parameter_name }}">
            </td>
            {% for param in fuzzy_set.parameter_values %}
            <td class="matrics-table__td matrics-table__parameter">
                <input type="text" name="parameter_value_td_input" value="{{ param }}">
            </td>
            {% endfor %}
        </tr>
    
        <!-- Matrix A -->
        {% for i in range(fuzzy_set.n) %}
        <tr class="matrics-table__row">
            <td class="matrics-table__td matrics-table__parameter">{{ fuzzy_set.parameter_values[i] }}</td>
            {% for elem in fuzzy_set.A[i] %}
            <td class="matrics-table__td">
                {% if i != (fuzzy_set.n - 1) %}
                    {{ elem|format_precision(precision) }}
                {% else %}
                    <input type="text" name="expert_evaluation_td_input" value="{{ elem|format_precision(precision) }}">
                {% endif %}
            </td>
            {% endfor %}
        </tr>
        {% endfor %}
    
        <!-- Additional rows -->
        <tr class="matrics-table__row">
            <td class="matrics-table__td">1</td>
            {% for elem in fuzzy_set.column_sums %}
            <td class="matrics-table__td">{{ elem|format_precision(precision) }}</td>
            {% endfor %}
        </tr>
        <tr class="matrics-table__row">
            <td class="matrics-table__td">2</td>
            {% for elem in fuzzy_set.inverted_sums %}
            <td class="matrics-table__td">{{ elem|format_precision(precision) }}</td>
            {% endfor %}
        </tr>
        <tr class="matrics-table__row">
            <td class="matrics-table__td">M(X)</td>
            {% for elem in fuzzy_set.membership_function %}
            <td class="matrics-table__td">{{ elem|format_precision(precision) }}</td>
            {% endfor %}
        </tr>
    </table>

    <canvas id="FuzzySetChart" class="chart-canvas" width="750" height="350"></canvas>
    <script>
        var ctx = document.getElementById("FuzzySetChart").getContext("2d");
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: {{ x_axis | list | safe }},
                datasets: [{
                    data: {{ y_axis | list | safe }},
                    borderWidth: 1,
                }]
            },
            options: {
                responsive: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Графік нечіткої множини',
                        font: {
                            family: 'Times',
                            size: 20,
                            style: 'normal',
                            lineHeight: 1.2,
                        },
                        color: 'black',
                    },
                    legend: {
                        display: false,
                    },  
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: "{{ fuzzy_set.parameter_name | safe }}",
                            font: {
                                family: 'Arial',
                                size: 14,
                                style: 'normal',
                                lineHeight: 1.2,
                            },
                            color: 'black',
                        },
                    },
                    /*y: {
                        title: {
                            display: true,
                            text: 'Значення функції належності',
                            font: {
                                family: 'Arial',
                                size: 16,
                                style: 'normal',
                                lineHeight: 1.2,
                            },
                            color: 'black',
                        },
                    },*/
                }     
            }
        });
    </script>
    <script src="../static/js/render_table.js"></script>
    <script>
        // Function to handle the Enter key press event
        function handleEnter(event) {
            if (event.key === 'Enter') {
                console.log("Enter btn was clicked!");

                // Get the updated parameter name
                var parameterName = document.querySelector('input[name="parameter_name_td_input"]').value;

                // Get the updated parameter values
                var parameterValues = [];
                var parValInputFields = document.querySelectorAll('input[name="parameter_value_td_input"]');
                parValInputFields.forEach(function(input) {
                    parameterValues.push(input.value);
                });

                // Get the updated expert evaluations
                var expertEvaluations = [];
                var expEvalInputFields = document.querySelectorAll('input[name="expert_evaluation_td_input"]')
                expEvalInputFields.forEach(function(input){
                    expertEvaluations.push(input.value);
                });

                var data = {
                    'parameter_name': parameterName,
                    'parameter_values': parameterValues,
                    'expert_evaluations': expertEvaluations
                };

                // Send the updated parameter values and expert evaluations to the server
                var xhr = new XMLHttpRequest();
                xhr.open('POST', '/update_parameters', true);
                xhr.setRequestHeader('Content-Type', 'application/json');
                xhr.onreadystatechange = function() {
                    if (xhr.readyState === XMLHttpRequest.DONE) {
                        if (xhr.status === 200) {
                            // Handle the response from the server (update the matrix and graph)
                            console.log('Get data from Flask server: ' + xhr.responseText);
                            var response = JSON.parse(xhr.responseText);

                            // Update the input values with the new parameter values
                            var fuzzySet = JSON.parse(response.fuzzy_set);
                            var parameterValues = fuzzySet.parameter_values;

                            // Render the table
                            renderTable(fuzzySet, {{ precision | safe }})

                            // Add eventListeners
                            document.querySelector('input[name="parameter_name_td_input"]').addEventListener('keypress', handleEnter);

                            var parValInputFields = document.querySelectorAll('input[name="parameter_value_td_input"]');
                            parValInputFields.forEach(function(input) {
                                input.addEventListener('keypress', handleEnter);
                            });

                            var expEvalInputFields = document.querySelectorAll('input[name="expert_evaluation_td_input"]');
                            expEvalInputFields.forEach(function(input){
                                input.addEventListener('keypress', handleEnter);
                            });
                            
                            // Redraw the graph with the new data
                            var existingChart = Chart.getChart("FuzzySetChart");
                            if (existingChart) {
                                existingChart.destroy();
                            }

                            var ctx = document.getElementById("FuzzySetChart").getContext("2d");
                            var chart = new Chart(ctx, {
                                type: 'line',
                                data: {
                                    labels: response.graph_data.x_axis,
                                    datasets: [{
                                        data: response.graph_data.y_axis,
                                        borderWidth: 1,
                                    }]
                                },
                                options: {
                                    responsive: false,
                                    plugins: {
                                        title: {
                                            display: true,
                                            text: 'Графік нечіткої множини',
                                            font: {
                                                family: 'Times',
                                                size: 20,
                                                style: 'normal',
                                                lineHeight: 1.2,
                                            },
                                            color: 'black',
                                        },
                                        legend: {
                                            display: false,
                                        },  
                                    },
                                    scales: {
                                        x: {
                                            title: {
                                                display: true,
                                                text: response.parameter_name,
                                                font: {
                                                    family: 'Arial',
                                                    size: 14,
                                                    style: 'normal',
                                                    lineHeight: 1.2,
                                                },
                                                color: 'black',
                                            },
                                        },
                                    }     
                                }
                            });
                        } else {
                            // Handle errors
                            console.error('Failed to update parameters:', xhr.status);
                        }
                    }
                };
                xhr.send(JSON.stringify(data));
            }
        }
    
        // Add event listeners to the input fields for the parameter name, parameter values and expert evaluations

        document.querySelector('input[name="parameter_name_td_input"]').addEventListener('keypress', handleEnter);

        var parValInputFields = document.querySelectorAll('input[name="parameter_value_td_input"]');
        parValInputFields.forEach(function(input) {
            input.addEventListener('keypress', handleEnter);
        });

        var expEvalInputFields = document.querySelectorAll('input[name="expert_evaluation_td_input"]');
        expEvalInputFields.forEach(function(input){
            input.addEventListener('keypress', handleEnter);
        });

    </script>
</div>

{% endblock %}